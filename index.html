<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ¨ ç¿»è½‰é­”æ³•æ²™æ¼ âœ¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');

        :root {
            --sand-color: #ed8936;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #1a202c;
            /* åŠ å…¥ä¸€é»é­”æ³•æ„Ÿçš„èƒŒæ™¯æ¼¸å±¤ */
            background-image: radial-gradient(circle at center, #2d3748 0%, #1a202c 100%);
            color: #e2e8f0;
            overflow: hidden; 
            touch-action: none; 
            height: 100dvh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        /* --- æ¶æ§‹åˆ†å±¤ --- */
        .hourglass-scaler {
            transform-origin: center center;
            transform: scale(0.9);
            transition: transform 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .hourglass-wrapper {
            will-change: transform;
            transform-origin: center center;
        }

        .animate-smooth {
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .hourglass-container {
            width: 130px;
            height: 220px;
            position: relative;
            filter: drop-shadow(0 0 15px rgba(0,0,0, 0.4));
            z-index: 10;
            overflow: hidden;
            border-radius: 40px;
            transform: translateZ(0); 
        }

        /* éœ‡å‹•å‹•ç•« */
        @keyframes shake-hard {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            10% { transform: translate(-2px, -2px) rotate(-2deg); }
            20% { transform: translate(2px, 2px) rotate(2deg); }
            30% { transform: translate(-2px, 2px) rotate(-2deg); }
            40% { transform: translate(2px, -2px) rotate(2deg); }
            50% { transform: translate(-2px, 0) rotate(-2deg); }
            60% { transform: translate(2px, 0) rotate(2deg); }
        }
        .shake-active {
            animation: shake-hard 0.4s ease-in-out infinite;
        }

        /* --- ç»ç’ƒçµ„ä»¶ (å›ºå®šç‚ºç¶“å…¸å½¢ç‹€) --- */
        .glass {
            position: absolute;
            width: 100%;
            height: 50%;
            border: 5px solid #cbd5e0;
            background: rgba(255, 255, 255, 0.05);
            overflow: hidden;
            box-sizing: border-box;
            z-index: 20;
            pointer-events: none;
        }
        
        .glass-top { 
            top: 0; 
            border-bottom: none; 
            border-radius: 40px 40px 50% 50%; /* ç¶“å…¸åœ“å¼§ */
        }
        .glass-bottom { 
            bottom: 0; 
            border-top: none; 
            border-radius: 50% 50% 40px 40px; /* ç¶“å…¸åœ“å¼§ */
        }

        /* --- æ²™å­ --- */
        .sand-fluid {
            position: absolute;
            width: 300px;
            height: 300px;
            top: 50%;
            left: 50%;
            margin-top: -150px;
            margin-left: -150px;
            background-color: var(--sand-color);
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.2'/%3E%3C/svg%3E");
            will-change: transform;
        }
        .glass .sand-fluid { z-index: -1; }

        /* --- æ²™æµ --- */
        .stream {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 120px; 
            margin-left: -2px;
            background-color: var(--sand-color);
            transform-origin: top center;
            z-index: 15;
            opacity: 0; 
            pointer-events: none;
        }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        .side-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #4a5568;
            margin-bottom: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: transparent; 
            background-size: cover;
        }
        .side-btn.active {
            border-color: white;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .btn-color { box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }

        input[type=number] {
            -moz-appearance: textfield;
            background: #2d3748;
            color: white;
            border: 1px solid #4a5568;
            text-align: center;
            font-size: 16px; 
        }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px;
            border-radius: 50%; background: #4299e1; 
            margin-top: -10px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #4a5568; border-radius: 2px;
        }

        @media (max-height: 700px) {
            .hourglass-scaler { 
                transform: scale(0.75); 
            }
            #timer { font-size: 1.8rem; }
        }
    </style>
</head>
<body class="bg-gray-900">

    <!-- é ‚éƒ¨ï¼šæ¨™é¡Œèˆ‡æ™‚é–“è¨­å®š -->
    <div class="w-full flex flex-col items-center pt-2 pb-2 z-50 shrink-0">
        <h1 class="text-white font-bold text-lg mb-2 drop-shadow-md tracking-wider">âœ¨ ç¿»è½‰é­”æ³•æ²™æ¼ âœ¨</h1>
        <div class="flex items-center gap-1 bg-gray-800/80 backdrop-blur p-2 rounded-full border border-gray-700 shadow-lg">
            <input type="number" id="hrInput" value="0" class="w-10 h-8 rounded text-base" placeholder="0">
            <span class="text-gray-500 text-xs">:</span>
            <input type="number" id="minInput" value="1" class="w-10 h-8 rounded text-base" placeholder="1">
            <span class="text-gray-500 text-xs">:</span>
            <input type="number" id="secInput" value="0" class="w-10 h-8 rounded text-base" placeholder="0">
            <button onclick="applyTimeSettings()" class="ml-2 px-4 h-8 bg-blue-600 rounded-full text-white text-xs font-bold shadow hover:bg-blue-500 transition-colors whitespace-nowrap">è¨­å®š</button>
        </div>
    </div>

    <!-- ä¸­é–“ï¼šä¸»è¦–åœ– -->
    <div class="flex-1 flex items-center justify-between w-full px-2 overflow-hidden relative">
        
        <!-- å·¦å´ï¼šé¡è‰²é¸æ“‡ -->
        <div class="flex flex-col items-center justify-center w-12 z-40 gap-2 shrink-0">
            <div class="text-[10px] text-gray-500 mb-1 font-bold">é¡è‰²</div>
            <button class="side-btn btn-color active" style="background-color: #ed8936;" onclick="setColor('#ed8936', this)"></button>
            <button class="side-btn btn-color" style="background-color: #4299e1;" onclick="setColor('#4299e1', this)"></button>
            <button class="side-btn btn-color" style="background-color: #48bb78;" onclick="setColor('#48bb78', this)"></button>
            <button class="side-btn btn-color" style="background-color: #9f7aea;" onclick="setColor('#9f7aea', this)"></button>
            <button class="side-btn btn-color" style="background-color: #f56565;" onclick="setColor('#f56565', this)"></button>
            <button class="side-btn btn-color" style="background-color: #e2e8f0;" onclick="setColor('#e2e8f0', this)"></button>
        </div>

        <!-- ä¸­é–“ï¼šæ²™æ¼ + è³‡è¨Š + æ»‘æ¡¿ -->
        <div class="flex-1 flex flex-col items-center justify-center h-full relative min-h-0 w-full">
            
            <div class="flex-1"></div>

            <!-- æ²™æ¼æœ¬é«” -->
            <div class="hourglass-scaler shrink-0 mb-2">
                <div class="hourglass-wrapper animate-smooth" id="rotator">
                    <div id="hourglassContainer" class="hourglass-container">
                        <div class="glass glass-top">
                            <div class="sand-fluid" id="sandTop"></div>
                        </div>
                        <div class="stream" id="stream"></div>
                        <div class="glass glass-bottom">
                            <div class="sand-fluid" id="sandBottom"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ™‚é–“èˆ‡ç‹€æ…‹ -->
            <div class="flex flex-col items-center shrink-0 mb-4 z-30">
                <div class="text-4xl font-mono font-bold text-white drop-shadow-md leading-none" id="timer">00:01:00</div>
                <div id="modeBadge" class="mt-1 px-2 py-0.5 bg-gray-700/80 rounded text-[10px] text-gray-300">æº–å‚™å°±ç·’</div>
            </div>

            <!-- æ‰‹å‹•æ»‘æ¡¿ -->
            <div id="sliderContainer" class="w-48 hidden z-50 flex-col gap-1 mb-2 shrink-0">
                <div class="flex justify-between items-end px-1 w-full">
                    <button onclick="snapToAngle(-180)" class="text-lg opacity-70 hover:opacity-100">â¬‡ï¸</button>
                    <button onclick="snapToAngle(0)" class="text-xl -mt-1 hover:scale-110 transition-transform">â¬†ï¸</button>
                    <button onclick="snapToAngle(180)" class="text-lg opacity-70 hover:opacity-100">â¬‡ï¸</button>
                </div>
                <input type="range" id="tiltSlider" min="-180" max="180" value="0" step="5" class="w-full cursor-pointer" oninput="handleManualTilt(this.value)">
            </div>

            <div class="flex-1"></div>
        </div>

        <!-- å³å´ï¼šä½”ä½ (ä¿æŒå¹³è¡¡) -->
        <div class="w-12 shrink-0"></div>
    </div>

    <!-- åº•éƒ¨ï¼šæ§åˆ¶å° -->
    <div class="w-full bg-gray-800 p-4 rounded-t-3xl shadow-2xl border-t border-gray-700 z-50 shrink-0">
        
        <div class="flex bg-gray-900 rounded-lg p-1 mb-4">
            <button onclick="setMode('gyro')" id="tabGyro" class="flex-1 py-2 text-xs font-bold rounded bg-blue-600 text-white transition-all">æ‰‹æ©Ÿæ„Ÿæ‡‰</button>
            <button onclick="setMode('manual')" id="tabManual" class="flex-1 py-2 text-xs font-bold rounded text-gray-400 hover:text-white transition-all">æ‰‹å‹•ç¿»è½‰</button>
        </div>

        <div class="flex gap-3">
            <button onclick="startUserAction()" id="startBtn" class="flex-[2] py-4 bg-green-600 active:bg-green-700 text-white rounded-2xl font-bold shadow-lg text-lg flex items-center justify-center gap-2">
                <span id="startIcon">â–¶</span> é–‹å§‹
            </button>
            <div class="flex flex-col flex-1 gap-2">
                <button onclick="pauseUserAction()" id="pauseBtn" class="flex-1 bg-yellow-600 active:bg-yellow-700 text-white rounded-xl text-xs font-bold">æš«åœ</button>
                <button onclick="resetTimer(true)" class="flex-1 bg-gray-600 active:bg-gray-700 text-white rounded-xl text-xs font-bold">é‡ç½®</button>
            </div>
        </div>

        <button onclick="requestPermission()" id="permBtn" class="w-full mt-3 py-2 border border-blue-500 text-blue-300 rounded-lg text-xs hidden">
            ğŸ“¡ é»æ“Šå•Ÿç”¨æ„Ÿæ‡‰å™¨æ¬Šé™
        </button>
        <div class="text-center mt-2 text-[10px] text-gray-600">v7.0-classic-only</div>
    </div>

    <script>
        let mode = 'manual'; // é è¨­æ‰‹å‹•
        let isRunning = false;
        let isManualPaused = true;
        let totalTime = 60;
        let timeLeft = 60;
        let timerInterval = null;
        let currentRotation = 0;
        let isInvertedMode = false;
        let audioCtx = null;
        let lastBeta = 90;
        let lastGamma = 0;

        const rotator = document.getElementById('rotator');
        const hourglassContainer = document.getElementById('hourglassContainer');
        const timerDisplay = document.getElementById('timer');
        const sandTop = document.getElementById('sandTop');
        const sandBottom = document.getElementById('sandBottom');
        const stream = document.getElementById('stream');
        const modeBadge = document.getElementById('modeBadge');
        const tiltSlider = document.getElementById('tiltSlider');
        const sliderContainer = document.getElementById('sliderContainer');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const permBtn = document.getElementById('permBtn');
        const tabGyro = document.getElementById('tabGyro');
        const tabManual = document.getElementById('tabManual');

        updateSandVisuals();
        
        function setColor(color, btn) {
            document.documentElement.style.setProperty('--sand-color', color);
            document.querySelectorAll('.btn-color').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function applyTimeSettings() {
            const h = parseInt(document.getElementById('hrInput').value) || 0;
            const m = parseInt(document.getElementById('minInput').value) || 0;
            const s = parseInt(document.getElementById('secInput').value) || 0;
            
            let newTime = h * 3600 + m * 60 + s;
            if (newTime <= 0) newTime = 10;

            totalTime = newTime;
            resetTimer(true);
        }

        function setMode(newMode) {
            mode = newMode;
            if (mode === 'gyro') {
                tabGyro.className = "flex-1 py-2 text-xs font-bold rounded bg-blue-600 text-white transition-all";
                tabManual.className = "flex-1 py-2 text-xs font-bold rounded text-gray-400 hover:text-white transition-all";
                modeBadge.innerText = "æ¨¡å¼: æ‰‹æ©Ÿæ„Ÿæ‡‰";
                sliderContainer.classList.remove('flex');
                sliderContainer.classList.add('hidden');
                
                requestPermission();
                rotator.classList.remove('animate-smooth');
            } else {
                tabManual.className = "flex-1 py-2 text-xs font-bold rounded bg-blue-600 text-white transition-all";
                tabGyro.className = "flex-1 py-2 text-xs font-bold rounded text-gray-400 hover:text-white transition-all";
                modeBadge.innerText = "æ¨¡å¼: æ‰‹å‹•æ»‘æ¡¿";
                sliderContainer.classList.remove('hidden');
                sliderContainer.classList.add('flex');
                
                rotator.classList.add('animate-smooth');
                tiltSlider.value = 0;
                handleManualTilt(0);
            }
        }

        function snapToAngle(angle) {
            tiltSlider.value = angle;
            handleManualTilt(angle);
        }

        function requestPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                permBtn.classList.remove('hidden');
                permBtn.onclick = () => {
                    DeviceOrientationEvent.requestPermission()
                        .then(res => {
                            if (res === 'granted') {
                                window.addEventListener('deviceorientation', handleOrientation);
                                permBtn.classList.add('hidden');
                            } else {
                                alert("æ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹ä½¿ç”¨æ‰‹å‹•æ¨¡å¼");
                            }
                        });
                };
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function handleOrientation(event) {
            if (mode !== 'gyro') return;
            const beta = event.beta;
            const gamma = event.gamma;
            if (beta === null || gamma === null) return;

            lastBeta = beta;
            lastGamma = gamma;

            let visualAngle = -gamma;
            if (Math.abs(beta) > 90) {
                if (visualAngle >= 0) visualAngle = 180 - visualAngle;
                else visualAngle = -180 - visualAngle;
            }
            updateRotationLogic(visualAngle);
        }

        function handleManualTilt(val) {
            if (mode !== 'manual') return;
            updateRotationLogic(parseInt(val));
        }

        function updateRotationLogic(angle) {
            currentRotation = angle;
            rotator.style.transform = `rotate(${angle}deg)`;

            let normAngle = angle % 360;
            if (normAngle > 180) normAngle -= 360;
            if (normAngle < -180) normAngle += 360;

            const isUpright = Math.abs(normAngle) < 45;
            const isUpsideDown = Math.abs(normAngle) > 135;

            if (isUpsideDown && !isInvertedMode) {
                isInvertedMode = true;
                if(timeLeft < totalTime) timeLeft = totalTime - timeLeft;
            } else if (isUpright && isInvertedMode) {
                isInvertedMode = false;
                if(timeLeft < totalTime) timeLeft = totalTime - timeLeft;
            }

            const canFlow = Math.abs(normAngle) <= 45 || Math.abs(normAngle) >= 135;

            if (isManualPaused) {
                pauseTimer();
            } else {
                if (canFlow) {
                    if (!isRunning && timeLeft > 0) startTimer();
                    modeBadge.innerText = isInvertedMode ? "å€’ç½®è¨ˆæ™‚ä¸­" : "æ­£ç«‹è¨ˆæ™‚ä¸­";
                    modeBadge.className = "mt-1 px-2 py-0.5 bg-green-600 rounded text-[10px] text-white";
                } else {
                    if (isRunning) pauseTimer();
                    modeBadge.innerText = "è§’åº¦å‚¾æ–œ (æš«åœ)";
                    modeBadge.className = "mt-1 px-2 py-0.5 bg-yellow-600 rounded text-[10px] text-white";
                }
            }
            updateSandVisuals(canFlow);
        }

        function updateSandVisuals(showStream = true) {
            let pct = 0;
            if (totalTime > 0) pct = 1 - (timeLeft / totalTime);

            const drainStart = 110; 
            const drainEnd = 205;   
            const fillStart = 205;  
            const fillEnd = 110;    

            const drainY = drainStart + (pct * (drainEnd - drainStart));
            const fillY = fillStart - (pct * (fillStart - fillEnd));

            if (!isInvertedMode) {
                sandTop.style.transform = `rotate(${-currentRotation}deg) translateY(${drainY}px)`;
                sandBottom.style.transform = `rotate(${-currentRotation}deg) translateY(${fillY}px)`;
            } else {
                sandBottom.style.transform = `rotate(${-currentRotation}deg) translateY(${drainY}px)`;
                sandTop.style.transform = `rotate(${-currentRotation}deg) translateY(${fillY}px)`;
            }

            stream.style.transform = `rotate(${-currentRotation}deg)`;
            
            if (showStream && isRunning && timeLeft > 0) {
                stream.style.opacity = '1';
            } else {
                stream.style.opacity = '0';
            }
        }

        function startUserAction() {
            initAudio();
            if (timeLeft <= 0) {
                resetTimer(true);
                return;
            }
            isManualPaused = false;
            updateButtonUI();
            
            if (mode === 'manual') {
                handleManualTilt(tiltSlider.value);
            } else {
                handleOrientation({ beta: lastBeta, gamma: lastGamma });
            }
        }

        function pauseUserAction() {
            isManualPaused = true;
            pauseTimer();
            updateButtonUI();
            modeBadge.innerText = "å·²æš«åœ";
            modeBadge.className = "mt-1 px-2 py-0.5 bg-yellow-600 rounded text-[10px] text-white";
        }

        function startTimer() {
            if (isRunning) return;
            isRunning = true;
            
            let lastTime = Date.now();
            timerInterval = setInterval(() => {
                const now = Date.now();
                const delta = (now - lastTime) / 1000;
                lastTime = now;
                timeLeft -= delta;
                
                if (timeLeft <= 0) {
                    timeLeft = 0;
                    finishTimer();
                } else {
                    updateTimeDisplay();
                    let normAngle = currentRotation % 360;
                    if (normAngle > 180) normAngle -= 360;
                    if (normAngle < -180) normAngle += 360;
                    const canFlow = Math.abs(normAngle) <= 45 || Math.abs(normAngle) >= 135;
                    updateSandVisuals(canFlow);
                }
            }, 30);
        }

        function pauseTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            stream.style.opacity = '0';
            hourglassContainer.classList.remove('shake-active');
        }

        function finishTimer() {
            pauseTimer();
            updateTimeDisplay();
            updateSandVisuals(false);
            modeBadge.innerText = "æ™‚é–“åˆ°ï¼";
            modeBadge.className = "mt-1 px-2 py-0.5 bg-red-600 rounded text-[10px] text-white";
            playAlarm();
            hourglassContainer.classList.add('shake-active');
            isManualPaused = true;
            updateButtonUI();
        }

        function resetTimer(fullStop = true) {
            pauseTimer();
            if (fullStop) {
                timeLeft = totalTime;
                isInvertedMode = false;
                isManualPaused = true;
                updateButtonUI();
                modeBadge.innerText = "å·²é‡ç½®";
                modeBadge.className = "mt-1 px-2 py-0.5 bg-gray-600 rounded text-[10px] text-white";
                if (mode === 'manual') {
                    tiltSlider.value = 0;
                    handleManualTilt(0);
                }
            }
            updateTimeDisplay();
            updateSandVisuals();
        }

        function updateTimeDisplay() {
            let t = Math.ceil(timeLeft);
            const h = Math.floor(t / 3600);
            t %= 3600;
            const m = Math.floor(t / 60);
            const s = t % 60;
            const text = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            document.getElementById('timer').innerText = text;
        }

        function updateButtonUI() {
            if (isManualPaused) {
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                pauseBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                pauseBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        function playAlarm() {
            initAudio();
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            if (!audioCtx) return;
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(880, now);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.5);
            osc.start(now);
            osc.stop(now + 0.5);
        }
        
        // åˆå§‹åŸ·è¡Œä¸€æ¬¡è¨­å®šæ¨¡å¼ï¼Œç¢ºä¿ UI æ­£ç¢º
        setMode('manual');
    </script>
</body>
</html>

