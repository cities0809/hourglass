<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çœŸå¯¦ç‰©ç†æ²™æ¼ (æ„Ÿæ‡‰ä¿®å¾©ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');

        :root {
            --sand-color: #ed8936; /* é è¨­æ©™è‰² */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            overflow-y: auto;
            touch-action: pan-y; 
            min-height: 100dvh;
        }

        /* --- ç´‹ç†èˆ‡æè³ª --- */
        .sand-texture {
            background-color: var(--sand-color);
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
            transition: background-color 0.3s ease;
        }

        /* --- æ²™æ¼çµæ§‹ --- */
        .hourglass-wrapper {
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            will-change: transform;
            transform-origin: center center;
        }

        .hourglass-container {
            width: 160px;
            height: 280px;
            position: relative;
            margin: 0 auto;
            filter: drop-shadow(0 0 20px rgba(0,0,0, 0.3));
            z-index: 10;
        }

        /* éœ‡å‹•å‹•ç•« */
        @keyframes shake-hard {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-active {
            animation: shake-hard 0.5s ease-in-out infinite;
        }

        /* --- ç»ç’ƒçƒé«” --- */
        .glass {
            position: absolute;
            width: 100%;
            height: 50%;
            border: 6px solid #cbd5e0;
            background: rgba(255, 255, 255, 0.05);
            overflow: hidden;
            box-sizing: border-box;
            z-index: 20;
            pointer-events: none;
            transition: border-radius 0.3s ease;
        }
        
        .shape-classic .glass-top { border-radius: 40px 40px 50% 50%; }
        .shape-classic .glass-bottom { border-radius: 50% 50% 40px 40px; }
        .shape-modern .glass-top { border-radius: 10px 10px 40px 40px; }
        .shape-modern .glass-bottom { border-radius: 40px 40px 10px 10px; }
        .shape-round .glass-top { border-radius: 50% 50% 50% 50%; transform: scale(0.95); margin-bottom: 2px;}
        .shape-round .glass-bottom { border-radius: 50% 50% 50% 50%; transform: scale(0.95); margin-top: 2px;}
        .glass-top { top: 0; border-bottom: none; }
        .glass-bottom { bottom: 0; border-top: none; }

        /* --- æ²™å­æµé«”å¡Š --- */
        .sand-fluid {
            position: absolute;
            width: 300px;
            height: 300px;
            top: 50%;
            left: 50%;
            margin-top: -150px;
            margin-left: -150px;
            transform-origin: center center;
            will-change: transform;
        }
        .glass .sand-fluid { z-index: -1; }

        /* --- ä¸­é–“æ²™æµ --- */
        .stream-container {
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            z-index: 15;
            overflow: visible; 
        }
        .stream {
            position: absolute;
            top: 0; left: -2px;
            width: 4px; height: 140px;
            background-color: var(--sand-color);
            opacity: 0;
            transform-origin: top center;
            transition: opacity 0.1s, background-color 0.3s ease;
        }
        .stream.active { opacity: 1; }

        /* --- UI å…ƒä»¶ --- */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px;
            border-radius: 50%; background: var(--sand-color); cursor: pointer; margin-top: -10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: background-color 0.3s;
            border: 2px solid #fff;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #4a5568; border-radius: 3px;
        }
        input[type=number] {
            -moz-appearance: textfield;
            background: #2d3748;
            color: white;
            border: 1px solid #4a5568;
            text-align: center;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number]:focus { outline: none; border-color: var(--sand-color); }
        select {
            background-color: #2d3748;
            color: white;
            border: 1px solid #4a5568;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-[100dvh] py-6 px-4 bg-gray-900">

    <!-- é ‚éƒ¨å€å¡Šï¼šæ™‚é–“è¨­å®š -->
    <div class="w-full max-w-lg flex flex-col items-center gap-3 z-50 mb-6">
        <div class="flex items-center gap-2 bg-gray-800 p-2 rounded-xl shadow-lg border border-gray-700 w-full justify-center">
            <div class="flex flex-col items-center">
                <input type="number" id="hrInput" value="0" min="0" max="23" class="w-10 h-8 text-base rounded" placeholder="00">
                <span class="text-[9px] text-gray-400">æ™‚</span>
            </div>
            <span class="text-white text-base font-bold pb-3">:</span>
            <div class="flex flex-col items-center">
                <input type="number" id="minInput" value="1" min="0" max="59" class="w-10 h-8 text-base rounded" placeholder="01">
                <span class="text-[9px] text-gray-400">åˆ†</span>
            </div>
            <span class="text-white text-base font-bold pb-3">:</span>
            <div class="flex flex-col items-center">
                <input type="number" id="secInput" value="0" min="0" max="59" class="w-10 h-8 text-base rounded" placeholder="00">
                <span class="text-[9px] text-gray-400">ç§’</span>
            </div>
            <button onclick="applyTimeSettings()" class="ml-2 h-8 bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 rounded-lg transition-colors font-bold shadow-md">
                è¨­å®š
            </button>
        </div>
    </div>

    <!-- æ²™æ¼ä¸»é«” -->
    <div class="flex-1 flex flex-col items-center justify-center w-full relative mb-4">
        <div class="hourglass-wrapper mb-6" id="rotator">
            <div id="hourglassContainer" class="hourglass-container shape-classic">
                <div class="glass glass-top">
                    <div class="sand-fluid sand-texture" id="sandTop"></div>
                </div>
                <div class="stream-container">
                    <div class="stream" id="stream"></div>
                </div>
                <div class="glass glass-bottom">
                    <div class="sand-fluid sand-texture" id="sandBottom"></div>
                </div>
            </div>
        </div>

        <!-- å€’æ•¸è¨ˆæ™‚é¡¯ç¤º -->
        <div class="text-5xl font-mono font-bold text-white tracking-widest drop-shadow-xl mb-2" id="timer">
            00:01:00
        </div>
        <div id="modeBadge" class="px-3 py-1 bg-gray-700 rounded-full text-xs font-bold text-gray-300 shadow-md mb-6">
            æº–å‚™å°±ç·’
        </div>

        <!-- æ‰‹å‹•æ¨¡å¼å…§å®¹ (ç§»è‡³æ­¤è™•) -->
        <div id="panelManual" class="hidden w-full max-w-xs space-y-3 mb-6 z-50">
            <!-- å¿«é€Ÿå®šä½åœ–ç¤º -->
            <div class="flex justify-between items-end px-1">
                <button onclick="snapToAngle(-180)" class="flex flex-col items-center group">
                    <span class="text-xl group-hover:scale-125 transition-transform">â¬‡ï¸</span>
                    <span class="text-[10px] text-gray-500 group-hover:text-white">å€’ç½®</span>
                </button>
                
                <button onclick="snapToAngle(0)" class="flex flex-col items-center group -mt-2">
                    <span class="text-2xl group-hover:scale-125 transition-transform">â¬†ï¸</span>
                    <span class="text-xs font-bold text-white group-hover:text-green-400">ç›´ç«‹</span>
                </button>

                <button onclick="snapToAngle(180)" class="flex flex-col items-center group">
                    <span class="text-xl group-hover:scale-125 transition-transform">â¬‡ï¸</span>
                    <span class="text-[10px] text-gray-500 group-hover:text-white">å€’ç½®</span>
                </button>
            </div>

            <!-- æ»‘æ¡¿ -->
            <div class="relative w-full h-8 flex items-center">
                <input type="range" id="tiltSlider" min="-180" max="180" value="0" list="snap-points"
                    class="w-full z-10 cursor-pointer" oninput="handleManualTilt(this.value)">
                
                <datalist id="snap-points">
                    <option value="-180"></option>
                    <option value="0"></option>
                    <option value="180"></option>
                </datalist>

                <!-- åˆ»åº¦ç·š -->
                <div class="absolute w-full top-1/2 h-1 flex justify-between px-[10px] pointer-events-none transform -translate-y-1/2">
                    <div class="w-0.5 h-2 bg-gray-600"></div>
                    <div class="w-0.5 h-3 bg-gray-500"></div>
                    <div class="w-0.5 h-2 bg-gray-600"></div>
                </div>
            </div>
            
            <div class="text-center text-[10px] text-gray-500">
                æ‹–æ›³æ»‘æ¡¿èª¿æ•´è§’åº¦
            </div>
        </div>

        <!-- ä¸»è¦æ§åˆ¶æŒ‰éˆ• -->
        <div class="flex gap-4 w-full max-w-xs z-50">
            <button onclick="startUserAction()" id="startBtn"
                class="flex-1 py-4 bg-green-600 hover:bg-green-500 text-white rounded-2xl font-bold shadow-xl transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2 text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                é–‹å§‹
            </button>
            <div class="flex flex-col gap-2 w-1/3">
                <button onclick="pauseUserAction()" id="pauseBtn"
                    class="flex-1 py-1 bg-yellow-600 hover:bg-yellow-500 text-white rounded-xl font-bold shadow-md text-sm">
                    æš«åœ
                </button>
                <button onclick="resetTimer(true)" 
                    class="flex-1 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded-xl font-bold shadow-md text-sm">
                    é‡ç½®
                </button>
            </div>
        </div>
    </div>

    <!-- è¨­å®šé¢æ¿ -->
    <div class="w-full max-w-sm bg-gray-800 p-5 rounded-3xl shadow-2xl border border-gray-700 z-50">
        
        <!-- åˆ†é åˆ‡æ› -->
        <div class="flex mb-4 bg-gray-900 rounded-xl p-1 border border-gray-700">
            <button onclick="setMode('gyro')" id="tabGyro" class="flex-1 py-2 text-sm font-bold rounded-lg bg-gray-700 text-white transition-all">
                æ‰‹æ©Ÿæ„Ÿæ‡‰
            </button>
            <button onclick="setMode('manual')" id="tabManual" class="flex-1 py-2 text-sm font-bold rounded-lg text-gray-400 hover:text-white transition-all">
                æ‰‹å‹•ç¿»è½‰
            </button>
        </div>

        <!-- æ„Ÿæ‡‰æ¨¡å¼å…§å®¹ -->
        <div id="panelGyro" class="space-y-3">
            <div class="text-xs text-gray-400 text-center">
                é»æ“Šä¸Šæ–¹ã€é–‹å§‹ã€‘å¾Œï¼Œå°‡æ‰‹æ©Ÿç›´ç«‹å³å¯
            </div>
            <button onclick="requestPermission()" id="permBtn"
                class="w-full py-3 bg-blue-900/50 border border-blue-500 text-blue-200 hover:bg-blue-900 hover:text-white rounded-xl font-bold text-sm transition-all">
                ğŸ“¡ é»æ“Šå•Ÿç”¨é™€èºå„€æ¬Šé™
            </button>
            <div id="gyroError" class="hidden p-3 bg-red-900/50 border border-red-500 rounded-lg text-red-200 text-xs text-center">
                ç„¡æ³•å­˜å–æ„Ÿæ‡‰å™¨ (è«‹æª¢æŸ¥æ¬Šé™æˆ–ä½¿ç”¨æ‰‹å‹•æ¨¡å¼)
            </div>
        </div>

        <!-- æ‰‹å‹•æ¨¡å¼å…§å®¹ (å·²ç§»é™¤ï¼Œç§»è‡³ä¸Šæ–¹) -->

        <!-- å¤–è§€è¨­å®š -->
        <div class="mt-4 pt-4 border-t border-gray-700 flex gap-3">
            <div class="flex-1">
                <select id="colorSelect" onchange="updateAppearance()" class="w-full bg-gray-900 border-gray-600 text-xs rounded-lg p-2 text-gray-300 focus:text-white focus:border-blue-500 outline-none">
                    <option value="#ed8936">æ´»åŠ›æ©˜</option>
                    <option value="#4299e1">æµ·æ´‹è—</option>
                    <option value="#48bb78">æ£®æ—ç¶ </option>
                    <option value="#9f7aea">ç¥ç§˜ç´«</option>
                    <option value="#f56565">ç†±æƒ…ç´…</option>
                    <option value="#e2e8f0">é›ªç™½è‰²</option>
                </select>
            </div>
            <div class="flex-1">
                <select id="shapeSelect" onchange="updateAppearance()" class="w-full bg-gray-900 border-gray-600 text-xs rounded-lg p-2 text-gray-300 focus:text-white focus:border-blue-500 outline-none">
                    <option value="shape-classic">ç¶“å…¸æ›²ç·š</option>
                    <option value="shape-modern">ç¾ä»£æ–¹è§’</option>
                    <option value="shape-round">åœ“æ½¤çƒå‹</option>
                </select>
            </div>
        </div>
    </div>

    <!-- ç‰ˆæœ¬è³‡è¨Š -->
    <div class="mt-8 mb-4 text-gray-600 text-xs font-mono opacity-50 text-center">
        v1.0.1-first edition
    </div>

    <script>
        let mode = 'gyro'; 
        let isRunning = false;
        let isManualPaused = true; 
        
        let setHours = 0;
        let setMinutes = 1;
        let setSeconds = 0;
        let totalTime = 60;
        let timeLeft = 60;
        
        let interval = null;
        let currentRotation = 0;
        let isInvertedMode = false;
        let audioCtx = null;

        // å¿«å–è®Šæ•¸ï¼Œç¢ºä¿é»æ“Šé–‹å§‹æ™‚å¯ä»¥ç«‹å³ä½¿ç”¨
        let lastIsUpsideDown = false;
        let lastIsUpright = true; // é è¨­ç›´ç«‹ï¼Œç¢ºä¿ç¬¬ä¸€æ¬¡é»æ“Šèƒ½é‹ä½œ
        let lastVisualRot = 0;

        // Elements
        const rotator = document.getElementById('rotator');
        const hourglassContainer = document.getElementById('hourglassContainer');
        const timerDisplay = document.getElementById('timer');
        const sandTop = document.getElementById('sandTop');
        const sandBottom = document.getElementById('sandBottom');
        const stream = document.getElementById('stream');
        const modeBadge = document.getElementById('modeBadge');
        
        const hrInput = document.getElementById('hrInput');
        const minInput = document.getElementById('minInput');
        const secInput = document.getElementById('secInput');
        const tiltSlider = document.getElementById('tiltSlider');
        
        const permBtn = document.getElementById('permBtn');
        const gyroError = document.getElementById('gyroError');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        
        const colorSelect = document.getElementById('colorSelect');
        const shapeSelect = document.getElementById('shapeSelect');
        const tabGyro = document.getElementById('tabGyro');
        const tabManual = document.getElementById('tabManual');

        // Init
        updateSandVisuals();
        updateAppearance();
        updateButtonStates();

        function updateAppearance() {
            const color = colorSelect.value;
            document.documentElement.style.setProperty('--sand-color', color);
            const shape = shapeSelect.value;
            hourglassContainer.className = `hourglass-container ${shape}`;
        }

        function applyTimeSettings() {
            let h = parseInt(hrInput.value);
            let m = parseInt(minInput.value);
            let s = parseInt(secInput.value);
            if (isNaN(h) || h < 0) h = 0;
            if (isNaN(m) || m < 0) m = 0;
            if (isNaN(s) || s < 0) s = 0;
            if (s > 59) s = 59;
            if (m > 59) m = 59;
            if (h === 0 && m === 0 && s === 0) s = 10;

            hrInput.value = h;
            minInput.value = m;
            secInput.value = s;
            
            setHours = h;
            setMinutes = m;
            setSeconds = s;
            totalTime = h * 3600 + m * 60 + s;
            resetTimer(true);
        }

        function setMode(newMode) {
            mode = newMode;
            const panelGyro = document.getElementById('panelGyro');
            const panelManual = document.getElementById('panelManual');

            if (mode === 'gyro') {
                panelGyro.classList.remove('hidden');
                panelManual.classList.add('hidden');
                
                tabGyro.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-blue-600 text-white transition-all shadow-md";
                tabManual.className = "flex-1 py-2 text-sm font-bold rounded-lg text-gray-400 hover:text-white transition-all";
                modeBadge.innerText = "æ¨¡å¼: æ‰‹æ©Ÿæ„Ÿæ‡‰";
            } else {
                panelGyro.classList.add('hidden');
                panelManual.classList.remove('hidden');
                
                tabManual.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-blue-600 text-white transition-all shadow-md";
                tabGyro.className = "flex-1 py-2 text-sm font-bold rounded-lg text-gray-400 hover:text-white transition-all";
                modeBadge.innerText = "æ¨¡å¼: æ‰‹å‹•ç¿»è½‰";
                handleManualTilt(0);
                tiltSlider.value = 0;
            }
        }

        function snapToAngle(angle) {
            tiltSlider.value = angle;
            handleManualTilt(angle);
        }

        function requestPermission() {
            initAudio();
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(res => {
                        if (res === 'granted') startGyro();
                        else showGyroError();
                    })
                    .catch(showGyroError);
            } else {
                startGyro();
            }
        }

        function startGyro() {
            window.addEventListener('deviceorientation', handleOrientation);
            permBtn.innerText = "æ„Ÿæ‡‰å™¨é‹ä½œä¸­";
            permBtn.className = "w-full py-3 bg-green-900/50 border border-green-500 text-green-200 rounded-xl font-bold text-sm transition-all";
            permBtn.disabled = true;
            gyroError.classList.add('hidden');
        }

        function showGyroError() {
            gyroError.classList.remove('hidden');
            permBtn.innerText = "æˆæ¬Šå¤±æ•—";
        }

        function handleOrientation(event) {
            if (mode !== 'gyro') return;
            const beta = event.beta; 
            const gamma = event.gamma;
            if (beta === null) return;

            const isUpsideDown = (beta < -45 || beta > 135);
            const isUpright = (beta > 45 && beta < 135);

            let visualRot = -gamma;
            if (visualRot > 60) visualRot = 60;
            if (visualRot < -60) visualRot = -60;
            
            // å„²å­˜ç‹€æ…‹ï¼Œä¾› startUserAction ä½¿ç”¨
            lastIsUpsideDown = isUpsideDown;
            lastIsUpright = isUpright;
            lastVisualRot = visualRot;

            updateStateAndVisuals(isUpsideDown, isUpright, visualRot);
        }

        function handleManualTilt(val) {
            if (mode !== 'manual') return;
            initAudio();
            val = parseInt(val);
            const isUpright = (val > -45 && val < 45);
            const isUpsideDown = (val < -135 || val > 135);
            updateStateAndVisuals(isUpsideDown, isUpright, val);
        }

        function updateStateAndVisuals(isUpsideDown, isUpright, angle) {
            currentRotation = angle;
            rotator.style.transform = `rotate(${angle}deg)`;

            const isAligned = Math.abs(angle) < 45 || Math.abs(angle) > 135;

            // 1. ç¿»è½‰é‚è¼¯
            if (isUpsideDown && !isInvertedMode) {
                isInvertedMode = true;
                timeLeft = totalTime - timeLeft;
                updateSandVisuals(isAligned);
            } else if (isUpright && isInvertedMode) {
                isInvertedMode = false;
                timeLeft = totalTime - timeLeft;
                updateSandVisuals(isAligned);
            } else {
                updateSandVisuals(isAligned);
            }

            // 2. è¨ˆæ™‚é‚è¼¯
            if (isManualPaused) {
                pauseTimer();
                modeBadge.innerText = "æº–å‚™å°±ç·’ / å·²æš«åœ";
                modeBadge.className = "px-3 py-1 bg-gray-600 rounded-full text-xs font-bold text-white shadow-md mb-6";
                hourglassContainer.classList.remove('shake-active');
            } else {
                if (isUpsideDown || isUpright) {
                    if (isAligned && timeLeft > 0 && !isRunning) {
                        startTimer();
                    } else if (!isAligned || timeLeft <= 0) {
                        pauseTimer();
                    }
                    
                    if (isRunning) {
                        modeBadge.innerText = isInvertedMode ? "å€’ç½®è¨ˆæ™‚ä¸­..." : "æ­£ç«‹è¨ˆæ™‚ä¸­...";
                        modeBadge.className = "px-3 py-1 bg-green-600 rounded-full text-xs font-bold text-white shadow-md mb-6";
                    } else if (timeLeft > 0) {
                        modeBadge.innerText = "å‚¾æ–œè§’åº¦éå¤§ (æš«åœ)";
                        modeBadge.className = "px-3 py-1 bg-yellow-600 rounded-full text-xs font-bold text-white shadow-md mb-6";
                    }
                } else {
                    if (isRunning) pauseTimer();
                    modeBadge.innerText = "æ©«æ”¾ (æš«åœä¸­)";
                    modeBadge.className = "px-3 py-1 bg-yellow-600 rounded-full text-xs font-bold text-white shadow-md mb-6";
                }
            }
        }

        function startUserAction() {
            initAudio();
            if (timeLeft <= 0) return; 
            isManualPaused = false;
            
            // å¼·åˆ¶è§¸ç™¼ä¸€æ¬¡æ›´æ–°ï¼Œè§£æ±ºæ„Ÿæ‡‰å»¶é²å•é¡Œ
            if(mode === 'manual') {
                handleManualTilt(tiltSlider.value);
            } else if (mode === 'gyro') {
                // ä½¿ç”¨å¿«å–çš„æ„Ÿæ‡‰æ•¸æ“š (å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œé è¨­æœƒæ˜¯ç›´ç«‹ç‹€æ…‹)
                updateStateAndVisuals(lastIsUpsideDown, lastIsUpright, lastVisualRot);
            }
            
            updateButtonStates();
            hourglassContainer.classList.remove('shake-active');
        }

        function pauseUserAction() {
            isManualPaused = true;
            pauseTimer();
            updateButtonStates();
            modeBadge.innerText = "å·²æš«åœ";
            modeBadge.className = "px-3 py-1 bg-yellow-600 rounded-full text-xs font-bold text-white shadow-md mb-6";
            hourglassContainer.classList.remove('shake-active');
        }

        function updateButtonStates() {
            if (isManualPaused) {
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-600');
                startBtn.classList.add('bg-green-600', 'hover:bg-green-500');
                startBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg> é–‹å§‹`;

                pauseBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                startBtn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-600');
                startBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
                startBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg> è¨ˆæ™‚ä¸­`;

                pauseBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function updateSandVisuals(showStream = true) {
            let pct = 0;
            if (totalTime > 0) {
                pct = 1 - (timeLeft / totalTime);
            }
            
            // ä¿®æ­£ï¼šä¸Šä¸‹æ–¹éƒ½é ç•™ç©ºé–“ï¼Œå½¢æˆå°ç¨±ç¾å­¸
            // ä¸Šæ–¹ (Draining): 100 (æ»¿ï¼Œç•™æœ‰ç©ºé–“) -> 230 (å®Œå…¨æ’ç©ºï¼Œç¢ºä¿ä½æ–¼ç“¶é ¸)
            const drainY = 100 + (pct * (230 - 100));
            // ä¸‹æ–¹ (Filling): 230 (å®Œå…¨ç©ºï¼Œç¢ºä¿èµ·å§‹ç„¡æ²™å­) -> 100 (æ»¿ï¼Œç•™æœ‰ç©ºé–“)
            const fillY = 230 - (pct * (230 - 100));

            if (!isInvertedMode) {
                sandTop.style.transform = `rotate(${-currentRotation}deg) translateY(${drainY}px)`;
                sandBottom.style.transform = `rotate(${-currentRotation}deg) translateY(${fillY}px)`;
            } else {
                sandBottom.style.transform = `rotate(${-currentRotation}deg) translateY(${drainY}px)`;
                sandTop.style.transform = `rotate(${-currentRotation}deg) translateY(${fillY}px)`;
            }
            stream.style.transform = `rotate(${-currentRotation}deg)`;
            
            if (!showStream || !isRunning) {
                stream.style.opacity = '0';
            } else {
                stream.style.opacity = '1';
            }
        }

        function startTimer() {
            if (isRunning) return;
            if (timeLeft <= 0) return;
            isRunning = true;
            
            let lastTime = Date.now();
            interval = setInterval(() => {
                const now = Date.now();
                const delta = (now - lastTime) / 1000;
                lastTime = now;
                timeLeft -= delta;
                
                const isAligned = Math.abs(currentRotation) < 45 || Math.abs(currentRotation) > 135;

                if (timeLeft <= 0) {
                    timeLeft = 0;
                    pauseTimer();
                    updateTimeDisplay();
                    updateSandVisuals(isAligned);
                    modeBadge.innerText = "æ™‚é–“åˆ°ï¼";
                    playAlarm();
                    isManualPaused = true; 
                    updateButtonStates();
                    hourglassContainer.classList.add('shake-active');
                } else {
                    updateTimeDisplay();
                    updateSandVisuals(isAligned);
                }
            }, 50);
        }

        function pauseTimer() {
            isRunning = false;
            clearInterval(interval);
            stream.style.opacity = '0';
        }

        function resetTimer(fullStop = true) {
            pauseTimer();
            if (fullStop) {
                timeLeft = totalTime; 
                isInvertedMode = false; 
                isManualPaused = true; 
                updateButtonStates();
                modeBadge.innerText = "å·²é‡ç½® (è«‹æŒ‰é–‹å§‹)";
                modeBadge.className = "px-3 py-1 bg-gray-600 rounded-full text-xs font-bold text-white shadow-md mb-6";
                if (mode === 'manual') {
                    snapToAngle(0);
                }
                hourglassContainer.classList.remove('shake-active');
            }
            updateTimeDisplay();
            updateSandVisuals();
        }

        function updateTimeDisplay() {
            let t = Math.ceil(timeLeft);
            const h = Math.floor(t / 3600);
            t %= 3600;
            const m = Math.floor(t / 60);
            const s = t % 60;
            let text = (h > 0 ? String(h).padStart(2,'0') + ":" : "00:") + String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0');
            timerDisplay.innerText = text;
        }

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        function playAlarm() {
            initAudio();
            if (!audioCtx) return;
            navigator.vibrate?.([200, 100, 200, 100, 400]);
            const now = audioCtx.currentTime;
            createBeep(now, 880, 0.1); 
            createBeep(now + 0.15, 587, 0.4); 
            createBeep(now + 0.8, 880, 0.1); 
            createBeep(now + 0.95, 587, 0.4); 
        }
        function createBeep(startTime, freq, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, startTime);
            gain.gain.setValueAtTime(0.1, startTime); 
            gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(startTime);
            osc.stop(startTime + duration);
        }
    </script>
</body>
</html>
